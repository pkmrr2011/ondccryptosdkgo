# Key Rotation Module

Terraform module to deploy the Key Rotation services.

## Features

Key components of this module consist of
- Key rotation service deployed in Cloud Run
- Secret in Secret Manager with [Rotation Schedule](https://cloud.google.com/secret-manager/docs/secret-rotation#workflow)

### Technical Details
These are important details of this module's behavior.
- When this module is deployed for the first time, the key rotaton service will generate new key pairs, store them in Secret Manager secret and send key rotation request to ONDC registry. Sending key rotation request will fail if your entity is not registerd. If it fails, it will retry for 2 - 3 times.
- Key pairs generated by this service is in the JSON format eg.
```json
{
  "encryptionKey": {
    "privateKeyEncryption": "3nrQndffw/dhO7OlwW4uk5d7er5W5E0B+R6Ua0+f6YM=",
    "publicKeyEncryption": "K+YtJdFIXxaIhuX3P5KAT3Z8zxUc/qibwHn8aWmSd1c=",
    "publicKeyEncryptionDER": "MCowBQYDK2VuAyEAK+YtJdFIXxaIhuX3P5KAT3Z8zxUc/qibwHn8aWmSd1c="
  },
  "signingKey": {
    "publicKeySigning": "R/4cp5ZCTPlRrTtth7Yt/v+/04K9lEnACdOz65q6GYA=",
    "signingKeySet": "eyJwcmltYXJ5S2V5SWQiOjEyNTE4NDA0MzEsICJrZXkiOlt7ImtleURhdGEiOnsidHlwZVVybCI6InR5cGUuZ29vZ2xlYXBpcy5jb20vZ29vZ2xlLmNyeXB0by50aW5rLkVkMjU1MTlQcml2YXRlS2V5IiwgInZhbHVlIjoiRWlBOUdDRm5rckJ0MHkrMVB3elByVzdVWHRyRWQyNWNDYW5zSzdRZjNaNHE3Um9pRWlCSC9oeW5sa0pNK1ZHdE8yMkh0aTMrLzcvVGdyMlVTY0FKMDdQcm1yb1pnQT09IiwgImtleU1hdGVyaWFsVHlwZSI6IkFTWU1NRVRSSUNfUFJJVkFURSJ9LCAic3RhdHVzIjoiRU5BQkxFRCIsICJrZXlJZCI6MTI1MTg0MDQzMSwgIm91dHB1dFByZWZpeFR5cGUiOiJSQVcifV19"
  }
}
```
When you need to provide public keys to ONDC, use these values in the following fields
- `encryptionKey.publicKeyEncryptionDER` for public encryption key
- `signingKey.publicKeySigning` for public signing key

## Example Usage
See the [terraform/examples/sample](../../examples/sample/)

## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_google"></a> [google](#requirement\_google) | 4.73.1 |
| <a name="requirement_google-beta"></a> [google-beta](#requirement\_google-beta) | 4.73.1 |
| <a name="requirement_random"></a> [random](#requirement\_random) | 3.5.1 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_google"></a> [google](#provider\_google) | 4.73.1 |
| <a name="provider_google-beta"></a> [google-beta](#provider\_google-beta) | 4.73.1 |
| <a name="provider_random"></a> [random](#provider\_random) | 3.5.1 |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_artifact_registry"></a> [artifact\_registry](#input\_artifact\_registry) | Artifact Registry where the Docker images stored | <pre>object({<br>    project_id = string,<br>    location   = string,<br>    repository = string,<br>  })</pre> | n/a | yes |
| <a name="input_location"></a> [location](#input\_location) | Cloud Run location. | `string` | n/a | yes |
| <a name="input_prefix"></a> [prefix](#input\_prefix) | Resouce Prefix. If it's not empty, it should contains `-` as a last character eg. `dev-` | `string` | `""` | no |
| <a name="input_project_id"></a> [project\_id](#input\_project\_id) | Google Cloud Project ID | `string` | n/a | yes |
| <a name="input_registry_url"></a> [registry\_url](#input\_registry\_url) | ONDC Registry URL | `string` | n/a | yes |
| <a name="input_request_id"></a> [request\_id](#input\_request\_id) | Arbitary ID (eg. UUID). This will be used when sending key rotation request to ONDC registry. It should be the same ID you will use in `onboarding` module. | `string` | n/a | yes |
| <a name="input_rotation_period"></a> [rotation\_period](#input\_rotation\_period) | Time between each key rotation. Default to 6 months. **WARNING**: changing this field after created the Secret Manager secret can delete all sercet versions. See this [issue](https://github.com/hashicorp/terraform-provider-google/issues/13770) | `string` | `"15780000s"` | no |
| <a name="input_secret_id"></a> [secret\_id](#input\_secret\_id) | Secret Manager's Secret ID | `string` | n/a | yes |
| <a name="input_service_accounts"></a> [service\_accounts](#input\_service\_accounts) | Service Accounts List as Secret Manager Admins | `list(string)` | n/a | yes |
| <a name="input_subscriber_id"></a> [subscriber\_id](#input\_subscriber\_id) | Subscriber ID of the ONDC entity ex. `ondcaccelerator.com` | `string` | n/a | yes |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_secret_id"></a> [secret\_id](#output\_secret\_id) | Secret Manager's Secret ID |

## Modules

No modules.

## Resources

| Name | Type |
|------|------|
| [google-beta_google_project_service_identity.pubsub_agent](https://registry.terraform.io/providers/hashicorp/google-beta/4.73.1/docs/resources/google_project_service_identity) | resource |
| [google-beta_google_project_service_identity.secret_manager_identity](https://registry.terraform.io/providers/hashicorp/google-beta/4.73.1/docs/resources/google_project_service_identity) | resource |
| [google_cloud_run_service.key_rotater](https://registry.terraform.io/providers/hashicorp/google/4.73.1/docs/resources/cloud_run_service) | resource |
| [google_cloud_run_service_iam_member.rotation_trigger_run_invoker](https://registry.terraform.io/providers/hashicorp/google/4.73.1/docs/resources/cloud_run_service_iam_member) | resource |
| [google_project_iam_member.project_token_creator](https://registry.terraform.io/providers/hashicorp/google/4.73.1/docs/resources/project_iam_member) | resource |
| [google_project_service.cloud_run](https://registry.terraform.io/providers/hashicorp/google/4.73.1/docs/resources/project_service) | resource |
| [google_project_service.pubsub](https://registry.terraform.io/providers/hashicorp/google/4.73.1/docs/resources/project_service) | resource |
| [google_project_service.secret_manager](https://registry.terraform.io/providers/hashicorp/google/4.73.1/docs/resources/project_service) | resource |
| [google_pubsub_subscription.key_rotation](https://registry.terraform.io/providers/hashicorp/google/4.73.1/docs/resources/pubsub_subscription) | resource |
| [google_pubsub_topic.key_rotation](https://registry.terraform.io/providers/hashicorp/google/4.73.1/docs/resources/pubsub_topic) | resource |
| [google_pubsub_topic_iam_member.sm_sa_publisher](https://registry.terraform.io/providers/hashicorp/google/4.73.1/docs/resources/pubsub_topic_iam_member) | resource |
| [google_secret_manager_secret.keys](https://registry.terraform.io/providers/hashicorp/google/4.73.1/docs/resources/secret_manager_secret) | resource |
| [google_secret_manager_secret_iam_member.key_rotater_secret_adder](https://registry.terraform.io/providers/hashicorp/google/4.73.1/docs/resources/secret_manager_secret_iam_member) | resource |
| [google_secret_manager_secret_iam_member.secretmanagerAdmin](https://registry.terraform.io/providers/hashicorp/google/4.73.1/docs/resources/secret_manager_secret_iam_member) | resource |
| [google_service_account.key_rotater](https://registry.terraform.io/providers/hashicorp/google/4.73.1/docs/resources/service_account) | resource |
| [google_service_account.rotation_trigger](https://registry.terraform.io/providers/hashicorp/google/4.73.1/docs/resources/service_account) | resource |
| [random_id.subscription_suffix](https://registry.terraform.io/providers/hashicorp/random/3.5.1/docs/resources/id) | resource |
| [random_id.topic_suffix](https://registry.terraform.io/providers/hashicorp/random/3.5.1/docs/resources/id) | resource |

